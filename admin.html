<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FlowScore Admin - Generare Link-uri</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
  <!-- Login Screen -->
  <div id="login-screen" class="max-w-md mx-auto mt-20">
    <div class="bg-white rounded-xl shadow-lg p-8">
      <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">FlowScore Admin</h1>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-1">Parolă Admin</label>
          <input type="password" id="adminPassword" placeholder="Introduceți parola"
                 class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none"
                 onkeypress="if(event.key==='Enter') checkPassword()">
        </div>
        <button onclick="checkPassword()"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2 rounded-lg transition-colors">
          Autentificare
        </button>
        <p id="login-error" class="text-red-500 text-sm text-center hidden">Parolă incorectă</p>
      </div>
    </div>
  </div>

  <!-- Admin Panel (hidden by default) -->
  <div id="admin-panel" class="max-w-2xl mx-auto hidden">
    <div class="bg-white rounded-xl shadow-lg p-8">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">FlowScore Admin</h1>
        <button onclick="logout()" class="text-gray-500 hover:text-gray-700 text-sm">Deconectare</button>
      </div>

      <!-- Generate Token Section -->
      <div class="mb-8">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Generare Link Nou</h2>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-600 mb-1">Nume Client (opțional)</label>
            <input type="text" id="clientName" placeholder="Ex: Firma ABC"
                   class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-600 mb-1">Email Client (opțional)</label>
            <input type="email" id="clientEmail" placeholder="Ex: contact@firma.ro"
                   class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none">
          </div>

          <button onclick="generateToken()"
                  class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2 rounded-lg transition-colors">
            Generează Link
          </button>
        </div>
      </div>

      <!-- Generated Link Section -->
      <div id="result" class="hidden">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Link Generat</h2>

        <div class="bg-gray-50 rounded-lg p-4 mb-4">
          <p class="text-sm text-gray-500 mb-2">Link de trimis clientului:</p>
          <div class="flex gap-2">
            <input type="text" id="generatedLink" readonly
                   class="flex-1 bg-white border border-gray-300 rounded-lg px-4 py-2 text-sm">
            <button onclick="copyLink()"
                    class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition-colors">
              Copiază
            </button>
          </div>
        </div>

        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
          <p class="text-green-700 text-sm">
            <strong>Token:</strong> <span id="tokenDisplay"></span>
          </p>
          <p class="text-green-600 text-xs mt-1">Token-ul a fost salvat în n8n.</p>
        </div>
      </div>

      <!-- Token List Section -->
      <div class="mt-8 pt-8 border-t">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Token-uri Active</h2>
        <div id="tokenList" class="space-y-2">
          <p class="text-gray-500 text-sm">Se încarcă...</p>
        </div>
      </div>
    </div>

    <!-- Configuration -->
    <div class="mt-4 text-center text-sm text-gray-500">
      <p>Base URL: <span id="baseUrl">-</span></p>
    </div>
  </div>

  <script>
    // ==========================================
    // CONFIGURATION
    // ==========================================
    const CONFIG = {
      baseUrl: window.location.origin + window.location.pathname.replace('admin.html', ''),
      n8nUrl: 'http://localhost:5678/webhook',
      // SCHIMBĂ ACEASTĂ PAROLĂ!
      adminPassword: 'flowscore2024'
    };

    // ==========================================
    // PASSWORD PROTECTION
    // ==========================================
    function checkPassword() {
      const input = document.getElementById('adminPassword').value;
      if (input === CONFIG.adminPassword) {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('admin-panel').classList.remove('hidden');
        document.getElementById('baseUrl').textContent = CONFIG.baseUrl;
        sessionStorage.setItem('admin_auth', 'true');
        loadTokens();
      } else {
        document.getElementById('login-error').classList.remove('hidden');
        document.getElementById('adminPassword').value = '';
      }
    }

    function logout() {
      sessionStorage.removeItem('admin_auth');
      document.getElementById('admin-panel').classList.add('hidden');
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('adminPassword').value = '';
    }

    // Check if already authenticated
    if (sessionStorage.getItem('admin_auth') === 'true') {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('admin-panel').classList.remove('hidden');
      document.getElementById('baseUrl').textContent = CONFIG.baseUrl;
    }

    // ==========================================
    // TOKEN MANAGEMENT
    // ==========================================

    // Generate token
    async function generateToken() {
      const clientName = document.getElementById('clientName').value;
      const clientEmail = document.getElementById('clientEmail').value;

      try {
        const response = await fetch(`${CONFIG.n8nUrl}/generate-token`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ clientName, clientEmail })
        });

        const data = await response.json();

        if (data.token) {
          const link = `${CONFIG.baseUrl}index.html?token=${data.token}`;
          document.getElementById('generatedLink').value = link;
          document.getElementById('tokenDisplay').textContent = data.token;
          document.getElementById('result').classList.remove('hidden');

          // Refresh token list
          loadTokens();
        } else {
          alert('Eroare la generare token');
        }
      } catch (error) {
        // Fallback: generate locally if n8n not available
        const token = 'fs_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        const link = `${CONFIG.baseUrl}index.html?token=${token}`;
        document.getElementById('generatedLink').value = link;
        document.getElementById('tokenDisplay').textContent = token;
        document.getElementById('result').classList.remove('hidden');
        console.warn('N8N not available, generated token locally:', token);
      }
    }

    // Copy link to clipboard
    function copyLink() {
      const link = document.getElementById('generatedLink');
      link.select();
      document.execCommand('copy');
      alert('Link copiat!');
    }

    // Load existing tokens
    async function loadTokens() {
      try {
        const response = await fetch(`${CONFIG.n8nUrl}/list-tokens`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.tokens && data.tokens.length > 0) {
          const list = document.getElementById('tokenList');
          list.innerHTML = data.tokens.map(t => `
            <div class="flex justify-between items-center bg-gray-50 rounded-lg px-4 py-2">
              <div>
                <span class="font-mono text-sm">${t.token}</span>
                ${t.clientName ? `<span class="text-gray-500 text-sm ml-2">(${t.clientName})</span>` : ''}
              </div>
              <span class="text-xs text-gray-400">${t.createdAt || ''}</span>
            </div>
          `).join('');
        } else {
          document.getElementById('tokenList').innerHTML = '<p class="text-gray-500 text-sm">Niciun token generat încă.</p>';
        }
      } catch (error) {
        document.getElementById('tokenList').innerHTML = '<p class="text-gray-500 text-sm">N8N nu este disponibil.</p>';
      }
    }

    // Load tokens on page load (only if authenticated)
    if (sessionStorage.getItem('admin_auth') === 'true') {
      loadTokens();
    }
  </script>
</body>
</html>
